<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv='content-type' content='text/html; charset=UTF-8'>
		<meta charset='utf-8'>

		<title>Browser SNES Controller</title>

		<style>
			body {
				position: relative;
				margin: 0;
				text-align: center;
			}
			#controller {
				margin: auto;
			}
			.button {
				position: absolute;
			}
			.button:hover {
				background-color: rgba(0, 0, 0, 0.2);
			}
			.pressed {
				outline: #FFFF66 solid medium;
			}
			#config {
				position: absolute;
				top: 0;
				left: 0;
			}
			.config-text {
				background-color: black;
				color: white;
				display: none;
			}
		</style>
	</head>

	<body>
		<img id='controller' src='svg_snes_controller.svg' />
		<button id='config'>Configure Keys</button>
		<div class='button' name='up' id='up_button'>
			<div class='config-text'>up</div>
		</div>
		<div class='button' name='down' id='down_button'>
			<div class='config-text'>down</div>
		</div>
		<div class='button' name='left' id='left_button'>
			<div class='config-text'>left</div>
		</div>
		<div class='button' name='right' id='right_button'>
			<div class='config-text'>right</div>
		</div>
		<div class='button' name='start' id='start_button'>
			<div class='config-text'>enter</div>
		</div>
		<div class='button' name='select' id='select_button'>
			<div class='config-text'>shift</div>
		</div>
		<div class='button' name='a' id='a_button'>
			<div class='config-text'>x</div>
		</div>
		<div class='button' name='b' id='b_button'>
			<div class='config-text'>z</div>
		</div>
		<div class='button' name='x' id='x_button'>
			<div class='config-text'>s</div>
		</div>
		<div class='button' name='y' id='y_button'>
			<div class='config-text'>a</div>
		</div>
		<div class='button' name='l' id='l_button'>
			<div class='config-text'>d</div>
		</div>
		<div class='button' name='r' id='r_button'>
			<div class='config-text'>c</div>
		</div>

		<script type='text/javascript'>

		/* button width, height, left, and top as a ratio of controller width */
		var buttonPositions = {};
		buttonPositions['up'] = [0.07, 0.07, 0.17, 0.20];
		buttonPositions['down'] = [0.07, 0.07, 0.17, 0.34];
		buttonPositions['left'] = [0.07, 0.07, 0.10, 0.27];
		buttonPositions['right'] = [0.07, 0.07, 0.24, 0.27];
		buttonPositions['start'] = [0.095, 0.08, 0.463, 0.293];
		buttonPositions['select'] = [0.095, 0.08, 0.36, 0.293];
		buttonPositions['a'] = [0.1, 0.1, 0.805, 0.255];
		buttonPositions['b'] = [0.1, 0.1, 0.705, 0.325];
		buttonPositions['x'] = [0.1, 0.1, 0.70, 0.175];
		buttonPositions['y'] = [0.1, 0.1, 0.60, 0.245];
		buttonPositions['l'] = [0.24, 0.06, 0.09, 0.06];
		buttonPositions['r'] = [0.24, 0.06, 0.62, 0.06];

		/* resize the controller when the window is resized */
		function resizeController(event) {
			/* resize controller image */
			var controller = document.getElementById('controller');
			controller.removeAttribute('height');
			controller.setAttribute('width', '80%');
			if (controller.offsetHeight > window.innerHeight) {
				controller.removeAttribute('width');
				controller.setAttribute('height', window.innerHeight + 'px');
			}
			var controllerWidth = controller.offsetWidth;
			var controllerLeft = (document.body.clientWidth - controllerWidth) / 2;
			/* resize buttons */
			var buttonDivs = document.getElementsByClassName('button');
			for (var i = 0; i < buttonDivs.length; i++) {
				var buttonDiv = buttonDivs[i];
				var buttonPosition = buttonPositions[buttonDiv.getAttribute('name')];
				buttonDiv.style.width = (controller.offsetWidth * buttonPosition[0]) + 'px';
				buttonDiv.style.height = (controller.offsetWidth * buttonPosition[1]) + 'px';
				buttonDiv.style.left = controllerLeft + (controller.offsetWidth * buttonPosition[2]) + 'px';
				buttonDiv.style.top = (controller.offsetWidth * buttonPosition[3]) + 'px';
			}
		}
		/* set the initial controller size when the page loads */
		window.onload = resizeController;
		/* window resize trigger */
		window.addEventListener('resize', resizeController);

		/* list of all button names */
		var buttons = ['up', 'down', 'left', 'right', 'start', 'select', 'a', 'b', 'x', 'y', 'l', 'r'];

		/* map from button name to boolean indicating whether or not it is pressed */
		var isPressed = {};
		for (var i = 0; i < buttons.length; i++) {
			isPressed[buttons[i]] = false;
		}

		/* map from key code to button name */
		var keyBindings = {
			38 : 'up',
			40 : 'down',
			37 : 'left',
			39 : 'right',
			13 : 'start',
			16 : 'select',
			88 : 'a',
			90 : 'b',
			83 : 'x',
			65 : 'y',
			68 : 'l',
			67 : 'r'
		};

		/* connect to server websocket */
		var host = location.host;
		if (host === '') {
			host = 'localhost';
		}
		host = host.split(':')[0];
		var socket = new WebSocket('ws://' + host + ':8081');

		/* button configuration state */
		var configuring = false;
		var buttonConfiguring = null;
		var buttonConfiguringText = null;

		/* handle keyboard input */
		document.onkeydown = function(event) {
			if (configuring) {
				if (buttonConfiguring) {
					var name = buttonConfiguring.getAttribute('name');
					for (key in keyBindings) {
						if (keyBindings.hasOwnProperty(key) && keyBindings[key] === name) {
							delete keyBindings[key];
							break;
						}
					}
					if (keyBindings[event.keyCode]) {
						document.getElementById(keyBindings[event.keyCode] + '_button').children[0].innerHTML = '';
					}
					keyBindings[event.keyCode] = name;
					var keyName = event.key;
					if (keyName === ' ') {
						keyName = 'space';
					} else if (keyName === 'ArrowUp') {
						keyName = 'up';
					} else if (keyName === 'ArrowDown') {
						keyName = 'down';
					} else if (keyName === 'ArrowLeft') {
						keyName = 'left';
					} else if (keyName === 'ArrowRight') {
						keyName = 'right';
					}
					buttonConfiguring.children[0].innerHTML = keyName;
					buttonConfiguring = null;
					buttonConfiguringText = null;
				}
			} else {
				var button = keyBindings[event.keyCode];
				if (button) {
					if (!isPressed[button]) {
						isPressed[button] = true;
						socket.send(button + ' down');
						document.getElementById(button + '_button').className = 'button pressed';
					}
				}
			}
		}
		document.onkeyup = function(event) {
			var button = keyBindings[event.keyCode];
			if (button) {
				if (isPressed[button]) {
					isPressed[button] = false;
					socket.send(button + ' up');
					document.getElementById(button + '_button').className = 'button';
				}
			}
		}

		/* handle mouse and touch input */
		Array.prototype.filter.call(document.getElementsByClassName('button'), function(buttonDiv) {
			function handleStart(event) {
				event.preventDefault();
				var button = buttonDiv.getAttribute('name');
				if (configuring) {
					if (buttonConfiguring && buttonConfiguringText) {
						buttonConfiguring.children[0].innerHTML = buttonConfiguringText;
					}
					buttonConfiguring = buttonDiv;
					buttonConfiguringText = buttonDiv.children[0].innerHTML;
					buttonDiv.children[0].innerHTML = '[press a key]';
				} else if (!isPressed[button]) {
					isPressed[button] = true;
					socket.send(button + ' down');
					buttonDiv.className = 'button pressed';
				}
			}
			function handleEnd(event) {
				event.preventDefault();
				var button = buttonDiv.getAttribute('name');
				if (isPressed[button]) {
					isPressed[button] = false;
					socket.send(button + ' up');
					buttonDiv.className = 'button';
				}
			}
			buttonDiv.addEventListener('touchstart', handleStart, false);
			buttonDiv.addEventListener('touchend', handleEnd, false);
			buttonDiv.addEventListener('touchleave', handleEnd, false);
			buttonDiv.addEventListener('touchcancel', handleEnd, false);
			buttonDiv.onmousedown = handleStart;
			buttonDiv.onmouseup = handleEnd;
			buttonDiv.onmouseleave = handleEnd;
		});

		/* handle configure button */
		var config = document.getElementById('config');
		config.onclick = function(event) {
			var display;
			if (!configuring) {
				config.innerHTML = 'Done';
				display = 'block';
			} else {
				if (buttonConfiguring && buttonConfiguringText) {
					buttonConfiguring.children[0].innerHTML = buttonConfiguringText;
				}
				config.innerHTML = 'Configure Keys';
				display = 'none';
			}
			Array.prototype.filter.call(document.getElementsByClassName('config-text'), function (configText) {
				configText.style.display = display;
			});
			configuring = !configuring;
		};

		/* prevent clicking from selecting the controller as an image */
		document.getElementById("controller").onclick = function(event) {
    	event.preventDefault();
		};
		/* prevent dragging from dragging the controller as an image */
		document.getElementById("controller").ondragstart = function(event) {
    	event.preventDefault();
		};

		</script>
	</body>
</html>
