<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv='content-type' content='text/html; charset=UTF-8'>
		<meta charset='utf-8'>

		<title>Browser SNES Controller</title>

		<style>
			body {
				position: relative;
				margin: 0;
				text-align: center;
			}
			#controller {
				margin: auto;
			}
			.button {
				position: absolute;
			}
			.button:hover {
				background-color: rgba(0, 0, 0, 0.2);
			}
			.pressed {
				outline: #FFFF66 solid medium;
			}
		</style>
	</head>

	<body>
		<img id='controller' src='svg_snes_controller.svg' />
		<div class='button' name='up' id='up_button'></div>
		<div class='button' name='down' id='down_button'></div>
		<div class='button' name='left' id='left_button'></div>
		<div class='button' name='right' id='right_button'></div>
		<div class='button' name='start' id='start_button'></div>
		<div class='button' name='select' id='select_button'></div>
		<div class='button' name='a' id='a_button'></div>
		<div class='button' name='b' id='b_button'></div>
		<div class='button' name='x' id='x_button'></div>
		<div class='button' name='y' id='y_button'></div>
		<div class='button' name='l' id='l_button'></div>
		<div class='button' name='r' id='r_button'></div>

		<script type='text/javascript'>

		/* button width, height, left, and top as a ratio of controller width */
		var buttonPositions = {};
		buttonPositions['up'] = [0.07, 0.07, 0.17, 0.20];
		buttonPositions['down'] = [0.07, 0.07, 0.17, 0.34];
		buttonPositions['left'] = [0.07, 0.07, 0.10, 0.27];
		buttonPositions['right'] = [0.07, 0.07, 0.24, 0.27];
		buttonPositions['start'] = [0.095, 0.08, 0.463, 0.293];
		buttonPositions['select'] = [0.095, 0.08, 0.36, 0.293];
		buttonPositions['a'] = [0.1, 0.1, 0.805, 0.255];
		buttonPositions['b'] = [0.1, 0.1, 0.705, 0.325];
		buttonPositions['x'] = [0.1, 0.1, 0.70, 0.175];
		buttonPositions['y'] = [0.1, 0.1, 0.60, 0.245];
		buttonPositions['l'] = [0.24, 0.06, 0.09, 0.06];
		buttonPositions['r'] = [0.24, 0.06, 0.62, 0.06];

		/* resize the controller when the window is resized */
		function resizeController(event) {
			/* resize controller image */
			var controller = document.getElementById('controller');
			controller.removeAttribute('height');
			controller.setAttribute('width', '80%');
			if (controller.offsetHeight > window.innerHeight) {
				controller.removeAttribute('width');
				controller.setAttribute('height', window.innerHeight + 'px');
			}
			var controllerWidth = controller.offsetWidth;
			var controllerLeft = (document.body.clientWidth - controllerWidth) / 2;
			/* resize buttons */
			var buttonDivs = document.getElementsByClassName('button');
			for (var i = 0; i < buttonDivs.length; i++) {
				var buttonDiv = buttonDivs[i];
				var buttonPosition = buttonPositions[buttonDiv.getAttribute('name')];
				buttonDiv.style.width = (controller.offsetWidth * buttonPosition[0]) + 'px';
				buttonDiv.style.height = (controller.offsetWidth * buttonPosition[1]) + 'px';
				buttonDiv.style.left = controllerLeft + (controller.offsetWidth * buttonPosition[2]) + 'px';
				buttonDiv.style.top = (controller.offsetWidth * buttonPosition[3]) + 'px';
			}
		}
		/* set the initial controller size when the page loads */
		window.onload = resizeController;
		/* window resize trigger */
		window.addEventListener('resize', resizeController);

		/* list of all button names */
		var buttons = ['up', 'down', 'left', 'right', 'start', 'select', 'a', 'b', 'x', 'y', 'l', 'r'];

		/* map from button name to boolean indicating whether or not it is pressed */
		var isPressed = {};
		for (var i = 0; i < buttons.length; i++) {
			isPressed[buttons[i]] = false;
		}

		/* map from key code to button name */
		var keyBindings = {
			38 : 'up',
			40 : 'down',
			37 : 'left',
			39 : 'right',
			13 : 'start',
			16 : 'select',
			88 : 'a',
			90 : 'b',
			83 : 'x',
			65 : 'y',
			68 : 'l',
			67 : 'r'
		};

		/* connect to server websocket */
		var host = location.host;
		if (host === '') {
			host = 'localhost';
		}
		host = host.split(':')[0];
		var socket = new WebSocket('ws://' + host + ':8081');

		/* handle keyboard input */
		document.onkeydown = function(event) {
			var button = keyBindings[event.keyCode];
			if (button) {
				if (!isPressed[button]) {
					isPressed[button] = true;
					socket.send(button + ' down');
					document.getElementById(button + '_button').className = 'button pressed';
				}
			}
		}

		document.onkeyup = function(event) {
			var button = keyBindings[event.keyCode];
			if (button) {
				if (isPressed[button]) {
					isPressed[button] = false;
					socket.send(button + ' up');
					document.getElementById(button + '_button').className = 'button';
				}
			}
		}

		/* handle mouse and touch input */
		Array.prototype.filter.call(document.getElementsByClassName('button'), function(buttonDiv) {
			function handleStart(event) {
				event.preventDefault();
				var button = buttonDiv.getAttribute('name');
				if (!isPressed[button]) {
					isPressed[button] = true;
					socket.send(button + ' down');
					buttonDiv.className = 'button pressed';
				}
			}
			function handleEnd(event) {
				event.preventDefault();
				var button = buttonDiv.getAttribute('name');
				if (isPressed[button]) {
					isPressed[button] = false;
					socket.send(button + ' up');
					buttonDiv.className = 'button';
				}
			}
			buttonDiv.addEventListener('touchstart', handleStart, false);
			buttonDiv.addEventListener('touchend', handleEnd, false);
			buttonDiv.addEventListener('touchleave', handleEnd, false);
			buttonDiv.addEventListener('touchcancel', handleEnd, false);
			buttonDiv.onmousedown = handleStart;
			buttonDiv.onmouseup = handleEnd;
			buttonDiv.onmouseleave = handleEnd;
		});

		/* prevent clicking from selecting the controller as an image */
		document.getElementById("controller").onclick = function(event) {
    	event.preventDefault();
		};
		/* prevent dragging from dragging the controller as an image */
		document.getElementById("controller").ondragstart = function(event) {
    	event.preventDefault();
		};

		</script>
	</body>
</html>
